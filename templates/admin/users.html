{% extends 'base.html' %}
{% block title %}Kullanıcı Yönetimi{% endblock %}
{% block content %}
<section class="card" style="margin-top: 20px;">
  <h2>Kullanıcı Yönetimi</h2>
  <p>Kayıtlı kullanıcıları görüntüleyin, rollerini değiştirin veya silin.</p>
  
  <div class="search-bar" style="margin: 16px 0;">
    <input type="text" id="search-input" placeholder="Kullanıcı adı veya email ile ara..." style="width: 100%; max-width: 400px;">
  </div>
  
  <div class="grid" style="margin-top: 20px;" id="users-list">
    {% for user in users %}
      <article class="card" data-username="{{ user.username|lower }}" data-email="{{ user.email|lower }}">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
          <div style="flex: 1;">
            <h3>{{ user.username }}</h3>
            <p class="muted">{{ user.email }}</p>
            <div style="margin: 8px 0;">
              <span class="badge" style="background: {% if user.role == 'admin' %}rgba(239,68,68,0.2); color: #ef4444{% elif user.role == 'yönetici' %}rgba(34,211,238,0.2); color: #22d3ee{% else %}rgba(156,163,175,0.2); color: #9ca3af{% endif %}; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                {{ user.role|title }}
              </span>
            </div>
            
            <!-- Şifre Bilgisi -->
            <div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; border: 1px solid rgba(255,255,255,0.1);">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 12px; color: var(--muted);">Şifre Hash:</span>
                <span id="password-display-{{ user.id }}" style="font-family: monospace; font-size: 12px; color: var(--text); background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px; letter-spacing: 1px;">••••••••</span>
                <button type="button" onclick="togglePassword({{ user.id }}, '{{ user.password_preview }}')" style="background: none; border: 1px solid rgba(255,255,255,0.2); color: var(--text); padding: 2px 6px; border-radius: 4px; font-size: 10px; cursor: pointer;">Göster</button>
              </div>
              
              <!-- Şifre Değiştirme Formu -->
              <form method="post" action="{{ url_for('change_user_password', user_id=user.id) }}" style="display: flex; gap: 6px; align-items: center;">
                <input type="password" name="password" placeholder="Yeni şifre (min 6 karakter)" style="flex: 1; background: var(--card); color: var(--text); border: 1px solid rgba(255,255,255,0.12); border-radius: 4px; padding: 4px 8px; font-size: 11px;" minlength="6" required>
                <button type="submit" style="background: var(--accent); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer;">Değiştir</button>
              </form>
            </div>
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 8px; margin-left: 16px;">
            <!-- Rol Değiştirme -->
            <form method="post" action="{{ url_for('change_user_role', user_id=user.id) }}" style="display: flex; gap: 6px; align-items: center;">
              <select name="role" style="background: var(--card); color: var(--text); border: 1px solid rgba(255,255,255,0.12); border-radius: 6px; padding: 4px 8px; font-size: 12px;">
                <option value="kullanıcı" {% if user.role == 'kullanıcı' %}selected{% endif %}>Kullanıcı</option>
                <option value="yönetici" {% if user.role == 'yönetici' %}selected{% endif %}>Yönetici</option>
                <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
              </select>
              <button class="btn" type="submit" style="padding: 4px 8px; font-size: 12px;">Rol Değiştir</button>
            </form>
            
            <!-- Kullanıcı Silme -->
            {% if not (user.role == 'admin' and users|selectattr('role', 'equalto', 'admin')|list|length <= 1) %}
            <form method="post" action="{{ url_for('delete_user', user_id=user.id) }}" style="display: inline;" onsubmit="return confirm('Bu kullanıcıyı silmek istediğinizden emin misiniz?')">
              <button class="btn secondary" type="submit" style="padding: 4px 8px; font-size: 12px; width: 100%;">Kullanıcıyı Sil</button>
            </form>
            {% endif %}
          </div>
        </div>
        <div style="font-size: 12px; color: var(--muted); margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span>ID: {{ user.id }} | Kayıt: {{ user.id }}. kullanıcı</span>
            <span style="color: var(--accent); font-weight: 600;">{{ user.last_login.strftime('%d.%m.%Y %H:%M') if user.last_login else 'Hiç giriş yapmamış' }}</span>
          </div>
          
          <!-- İstatistikler -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
            <div style="background: rgba(34,211,238,0.1); padding: 8px; border-radius: 6px; text-align: center;">
              <div style="font-size: 18px; font-weight: 600; color: #22d3ee;">{{ user.login_count }}</div>
              <div style="font-size: 10px; color: var(--muted);">Giriş Sayısı</div>
            </div>
            <div style="background: rgba(34,197,94,0.1); padding: 8px; border-radius: 6px; text-align: center;">
              <div style="font-size: 18px; font-weight: 600; color: #22c55e;">{{ user.post_count }}</div>
              <div style="font-size: 10px; color: var(--muted);">Paylaşım Sayısı</div>
            </div>
          </div>
        </div>
      </article>
    {% else %}
      <p class="muted">Henüz kullanıcı yok.</p>
    {% endfor %}
  </div>
</section>

<section class="card" style="margin-top: 20px;">
  <h3>Rol Açıklamaları</h3>
  <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
    <div>
      <h4 style="color: #ef4444;">Admin</h4>
      <ul style="font-size: 14px; margin: 8px 0; padding-left: 16px;">
        <li>Tam yetki</li>
        <li>Duyuru yönetimi</li>
        <li>Etkinlik yönetimi</li>
        <li>Kullanıcı yönetimi</li>
        <li>Fotoğraf yükleme</li>
        <li>Yazı paylaşımı</li>
      </ul>
    </div>
    <div>
      <h4 style="color: #22d3ee;">Yönetici</h4>
      <ul style="font-size: 14px; margin: 8px 0; padding-left: 16px;">
        <li>Fotoğraf yükleme</li>
        <li>Yazı paylaşımı</li>
        <li>Site görüntüleme</li>
      </ul>
    </div>
    <div>
      <h4 style="color: #9ca3af;">Kullanıcı</h4>
      <ul style="font-size: 14px; margin: 8px 0; padding-left: 16px;">
        <li>Sadece site görüntüleme</li>
        <li>İletişim formu</li>
      </ul>
    </div>
  </div>
</section>

{% endblock %}

{% block extra_scripts %}
<script>
// Şifre görüntüleme/gizleme
const passwordStates = {};

function togglePassword(userId, passwordPreview) {
  const display = document.getElementById(`password-display-${userId}`);
  const button = display.nextElementSibling;
  
  if (passwordStates[userId]) {
    // Şifreyi gizle
    display.textContent = '••••••••';
    button.textContent = 'Göster';
    passwordStates[userId] = false;
  } else {
    // Şifre hash'inin ilk kısmını göster
    display.textContent = passwordPreview;
    button.textContent = 'Gizle';
    passwordStates[userId] = true;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('search-input');
  const usersList = document.getElementById('users-list');
  const userCards = usersList.querySelectorAll('article[data-username]');
  
  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    userCards.forEach(card => {
      const username = card.dataset.username;
      const email = card.dataset.email;
      const matches = username.includes(query) || email.includes(query);
      card.style.display = matches ? 'block' : 'none';
    });
  });
  
  // Şifre değiştirme formlarını dinle
  const passwordForms = document.querySelectorAll('form[action*="sifre-degistir"]');
  passwordForms.forEach(form => {
    form.addEventListener('submit', (e) => {
      const passwordInput = form.querySelector('input[name="password"]');
      const submitBtn = form.querySelector('button[type="submit"]');
      
      if (passwordInput.value.length < 6) {
        e.preventDefault();
        alert('Şifre en az 6 karakter olmalıdır.');
        return;
      }
      
      // Butonu devre dışı bırak
      submitBtn.disabled = true;
      submitBtn.textContent = 'Değiştiriliyor...';
    });
  });
});
</script>
{% endblock %}
